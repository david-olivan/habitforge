name: Create Release Draft

# Trigger only when tags matching v*.*.* are pushed
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code with full history (needed for changelog)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      # Step 2: Generate changelog from conventional commits
      - name: Generate Changelog
        id: changelog
        uses: requarks/changelog-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          writeToFile: false

      # Step 3: Create GitHub Release (draft for manual APK upload)
      - name: Create Release Draft
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ${{ steps.changelog.outputs.changes }}

            ---

            ## ðŸ“¦ Download

            **Architecture:** ARM64-v8a (64-bit)
            **Android Version:** 7.0+ (API 24+)

            ### Installation
            1. Download the APK file below
            2. Enable "Install from Unknown Sources" if needed
            3. Open the APK file on your device
            4. Follow the installation prompts
          draft: true
          prerelease: ${{ startsWith(github.ref, 'refs/tags/v0.') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      # Step 4: Build summary
      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Release Draft Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Draft release created - manually upload APK and publish when ready!" >> $GITHUB_STEP_SUMMARY
